---
layout:     post                                
title:         Windows的页表们                   
subtitle:   Windows系统空间页表、进程页表的不同部分等  
date:       2017-12-23                    
author:    xSun                  
header-img:   img/windows-2017.jpg   
catalog: true                    
tags:                              
    - Windows
    - Kernel
---

>Windows代码不开源，只是释放出了一部分代码用做教学，这使得Windows内核充满了神秘感。内存管理一直是操作系统内核各个组成部分中最繁琐的一个，其中包括虚拟内存管理、物理内存管理以及连接二者的页表系统。此文将笔者几日来查阅到的Windows内存管理相关知识做以小结。

为方便描述，我们以32位为例。32位系统下，虚拟地址空间是4G，范围是0x0000,0000<—>0xFFFF,FFFF。Windows采用2G/2G的默认划分原则，即低2G空间为用户空间，高2G空间为系统空间。系统空间为所有用户所共享，为不同的用户提供服务。

---
## **系统地址空间初始化**

Windows将0xC000,0000<—>0xFFFF,FFFF此2G虚拟地址空间划分为各个部分：内核、HAL等系统模块的影像区，PFN数据库，非换页内存池，系统缓存额外区，系统PTE额外区，系统视图，会话空间，页表，超空间和进程工作集，系统缓存结构，换页内存池，系统PTE区域，保留区等。在系统初始化时，采取相关策略，调用一系列函数对其进行初始化。此处不再赘述，可参考《Windows内核原理与实现》或其他资料。

我们重点需要关心的是系统在启动时，会初始化系统空间的页表结构。32位下，使用2级页表就能够完成寻址要求。系统会通过不同的阶段来完成启动。在此时，Windows会建立起2G的系统空间的映射关系，即就是会建立起高2G的系统地址空间页表结构，包括页目录和相关的页表。至于Windows采用哪些黑科技来建立此页表结构，我们略去不谈。需要注意的结论是，**系统空间中使用的绝大多数页表都会在此时完成建立**，除了会话空间、系统视图和换页内存池部分，我们稍后继续讨论。

总结一下，Windows系统空间的页表结构在初始化时就会建立起来了。

---
## **用户地址空间初始化**

Windows在创建一个进程时，如果指定的父进程不为NULL，则需要创建一个新的地址空间。实际上就是要为进程创建页表，即进程用户态页表和内核态页表。此处我们只关心其内核态页表。

首先我们要明确一点，即就是**所有进程共享Windows系统空间页表**，就是我们上面讨论的那个页表。Windows系统空间页表在系统初始化时就建立，那时，系统（高2G）空间绝大多数的映射关系都已经建立好了。那具体是如何共享的呢？？

进程页目录共包含1024项PDE，其中后512项就是用于关联到系统空间的，系统在创建进程的地址空间时，直接将系统空间的PDE复制到此进程的页目录的对应位置处，而PDE中存储的就是各个页表的地址。实际上，这种机制，就是让此进程后半部分的页目录指向初始化时建立起的页表结构，那是个全局的页表结构。如下图所示：
![img](http://p194hb5ge.bkt.clouddn.com/windows-pt-structure.png)

---
## **地址空间切换**

当发生进程切换时，对应着地址空间的切换。参与切换的两个进程的用户空间是各自私有的，必然会发生切换，而它们内核态的页表部分其实是共享的，因此不论是哪个进程在运行，都是指向系统全局的系统空间页表结构。

上面我们提到，系统空间页表结构会将绝大部分的系统空间的映射关系建立起来，除了3种情况，我们此时只讨论换页内存池。当系统代码在某个进程环境中申请了换页内存池的内存，从而导致新的页表映射到页目录中，此时，新的映射关系只是写到了该进程的页目录中，只有该进程的PDE指向了此页表。当内核代码在另一进程环境中访问此内存时，发生页面错误，在页面错误处理函数中，此项映射关系将会同步到此时的进程所对应的PDE中。Windows使用MmSystemPagePtes记录换页内存的页表映射。Windows使用此机制来保持各个进程的内核态页目录保持一致。

---

## 结束

此文只是将Windows页表结构做了十分简略的说明，更加详细的内容需要参考其他资料，但搞清楚此文，笔者的研究目标已经达到了。
